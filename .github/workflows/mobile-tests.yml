name: SwiftEx Mobile Test Automation

on:
  # Allow manual triggering with parameters
  workflow_dispatch:
    inputs:
      platform:
        description: 'Test Platform'
        required: true
        default: 'android'
        type: choice
        options:
          - android
          - ios
          - androidSauce
          - iOSSauce
      
      device_name:
        description: 'Device Name (for local execution)'
        required: false
        default: 'emulator-5554'
        type: string
      
      test_tags:
        description: 'Cucumber Tags (e.g., @smoke, @pinValidationSuccess)'
        required: false
        default: '@createPin'
        type: string
      
      test_environment:
        description: 'Test Environment'
        required: true
        default: 'dev'
        type: choice
        options:
          - dev
          - staging
          - prod
      
      generate_allure_report:
        description: 'Generate Allure Report'
        required: false
        default: true
        type: boolean

  # Automatic triggers
  push:
    branches: [ main, develop, pin-creation ]
    paths:
      - 'src/**'
      - 'pom.xml'
      - '.github/workflows/**'
  
  pull_request:
    branches: [ main, develop ]
    paths:
      - 'src/**'
      - 'pom.xml'

  # Schedule for nightly runs
  schedule:
    # Run every day at 2 AM UTC (adjust timezone as needed)
    - cron: '0 2 * * *'

env:
  # Default values for automatic runs
  DEFAULT_PLATFORM: android
  DEFAULT_TEST_TAGS: '@createPin'
  DEFAULT_DEVICE_NAME: 'emulator-5554'
  JAVA_VERSION: '11'
  MAVEN_OPTS: '-Xmx2048m'

jobs:
  test:
    name: Mobile Tests - ${{ inputs.platform || 'android' }}
    runs-on: ubuntu-latest
    
    strategy:
      # Don't cancel other jobs if one fails
      fail-fast: false
    
    steps:
    - name: üì• Checkout Repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: ‚òï Set up JDK ${{ env.JAVA_VERSION }}
      uses: actions/setup-java@v4
      with:
        java-version: ${{ env.JAVA_VERSION }}
        distribution: 'temurin'
        cache: maven
    
    - name: üîß Configure Test Environment
      run: |
        echo "========================================="
        echo "üöÄ SwiftEx Mobile Test Configuration"
        echo "========================================="
        echo "Platform: ${{ inputs.platform || env.DEFAULT_PLATFORM }}"
        echo "Device: ${{ inputs.device_name || env.DEFAULT_DEVICE_NAME }}"
        echo "Tags: ${{ inputs.test_tags || env.DEFAULT_TEST_TAGS }}"
        echo "Environment: ${{ inputs.test_environment || 'dev' }}"
        echo "Trigger: ${{ github.event_name }}"
        echo "Branch: ${{ github.ref_name }}"
        echo "========================================="
        
        # Set environment variables for the test run
        echo "TEST_PLATFORM=${{ inputs.platform || env.DEFAULT_PLATFORM }}" >> $GITHUB_ENV
        echo "TEST_DEVICE=${{ inputs.device_name || env.DEFAULT_DEVICE_NAME }}" >> $GITHUB_ENV
        echo "TEST_TAGS=${{ inputs.test_tags || env.DEFAULT_TEST_TAGS }}" >> $GITHUB_ENV
        echo "TEST_ENV=${{ inputs.test_environment || 'dev' }}" >> $GITHUB_ENV
    
    - name: üîê Configure SauceLabs Credentials
      if: contains(inputs.platform || env.DEFAULT_PLATFORM, 'Sauce')
      run: |
        echo "üîê Setting up SauceLabs credentials for cloud execution..."
        echo "‚úÖ SauceLabs credentials configured from repository secrets"
      env:
        SAUCELABS_USERNAME: ${{ secrets.SAUCELABS_USERNAME }}
        SAUCELABS_ACCESS_KEY: ${{ secrets.SAUCELABS_ACCESS_KEY }}
    
    - name: üì± Set up Android SDK (for local Android tests)
      if: inputs.platform == 'android' || (inputs.platform == '' && env.DEFAULT_PLATFORM == 'android')
      uses: android-actions/setup-android@v3
      with:
        api-level: 33
        target: google_apis
        arch: x86_64
        profile: pixel_4
    
    - name: üöÄ Start Android Emulator (for local Android tests)
      if: inputs.platform == 'android' || (inputs.platform == '' && env.DEFAULT_PLATFORM == 'android')
      uses: reactivecircus/android-emulator-runner@v2
      with:
        api-level: 33
        target: google_apis
        arch: x86_64
        profile: pixel_4
        script: echo "Android emulator started"
        timeout-minutes: 10
    
    - name: üì¶ Install Node.js and Appium (for local tests)
      if: ${{ !contains(inputs.platform || env.DEFAULT_PLATFORM, 'Sauce') }}
      uses: actions/setup-node@v4
      with:
        node-version: '18'
    
    - name: üîß Install Appium Server (for local tests)
      if: ${{ !contains(inputs.platform || env.DEFAULT_PLATFORM, 'Sauce') }}
      run: |
        echo "üì¶ Installing Appium server and drivers..."
        npm install -g appium@latest
        appium driver install uiautomator2
        appium driver install xcuitest || echo "XCUITest driver installation skipped (iOS not available on Linux)"
        
        # Verify installation
        appium driver list --installed
        echo "‚úÖ Appium server installed successfully"
    
    - name: üèÉ Start Appium Server (for local tests)
      if: ${{ !contains(inputs.platform || env.DEFAULT_PLATFORM, 'Sauce') }}
      run: |
        echo "üöÄ Starting Appium server..."
        appium server --port 4723 --log-level info &
        
        # Wait for server to start
        timeout 60 bash -c 'until curl -f http://localhost:4723/status; do sleep 2; done'
        echo "‚úÖ Appium server is running on port 4723"
      env:
        APPIUM_LOG_LEVEL: info
    
    - name: ‚úÖ Validate Maven Configuration
      run: |
        echo "üîç Validating Maven configuration..."
        mvn validate
        mvn dependency:resolve
        echo "‚úÖ Maven configuration validated successfully"
    
    - name: üß™ Run Mobile Tests
      run: |
        echo "üß™ Starting mobile test execution..."
        echo "========================================="
        echo "Platform: $TEST_PLATFORM"
        echo "Device: $TEST_DEVICE" 
        echo "Tags: $TEST_TAGS"
        echo "Environment: $TEST_ENV"
        echo "========================================="
        
        # Build test command
        mvn clean test \
          -Dplatform="$TEST_PLATFORM" \
          -Dcucumber.filter.tags="$TEST_TAGS" \
          -DfailIfNoTests=false \
          -Dmaven.test.failure.ignore=true \
          -Dandroid.device.name="$TEST_DEVICE" \
          -Dios.device.name="$TEST_DEVICE"
        
        TEST_EXIT_CODE=$?
        echo "üèÅ Test execution completed with exit code: $TEST_EXIT_CODE"
        
        # Set result for later steps
        if [ $TEST_EXIT_CODE -ne 0 ]; then
          echo "‚ö†Ô∏è Tests had failures, but continuing to generate reports..."
          echo "TEST_FAILED=true" >> $GITHUB_ENV
        else
          echo "‚úÖ All tests passed successfully!"
          echo "TEST_FAILED=false" >> $GITHUB_ENV
        fi
      env:
        SAUCELABS_USERNAME: ${{ secrets.SAUCELABS_USERNAME }}
        SAUCELABS_ACCESS_KEY: ${{ secrets.SAUCELABS_ACCESS_KEY }}
    
    - name: üìä Generate Allure Report
      if: always() && (inputs.generate_allure_report == true || inputs.generate_allure_report == null)
      run: |
        echo "üìä Generating Allure test report..."
        
        # Generate report using Maven plugin
        if [ -d "target/allure-results" ] && [ "$(ls -A target/allure-results)" ]; then
          mvn allure:report || echo "‚ö†Ô∏è Allure report generation failed, continuing..."
          echo "‚úÖ Allure report generated successfully"
        else
          echo "‚ö†Ô∏è No Allure results found, skipping report generation"
        fi
    
    - name: üì§ Upload Test Results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: test-results-${{ inputs.platform || env.DEFAULT_PLATFORM }}-${{ github.run_number }}
        path: |
          target/surefire-reports/
          target/allure-results/
          target/site/allure-maven-plugin/
          target/screenshots/
        retention-days: 30
    
    - name: üì§ Upload Allure Report
      if: always() && (inputs.generate_allure_report == true || inputs.generate_allure_report == null)
      uses: actions/upload-artifact@v4
      with:
        name: allure-report-${{ inputs.platform || env.DEFAULT_PLATFORM }}-${{ github.run_number }}
        path: target/site/allure-maven-plugin/
        retention-days: 7
    
    - name: üí¨ Test Results Summary
      if: always()
      run: |
        echo "========================================="
        echo "üèÅ SwiftEx Mobile Test Execution Summary"
        echo "========================================="
        echo "Platform: $TEST_PLATFORM"
        echo "Device: $TEST_DEVICE"
        echo "Tags: $TEST_TAGS"
        echo "Environment: $TEST_ENV"
        echo "Branch: ${{ github.ref_name }}"
        echo "Commit: ${{ github.sha }}"
        echo "========================================="
        
        if [ "$TEST_FAILED" == "true" ]; then
          echo "‚ùå Test execution had failures"
          echo "üìä Check the uploaded artifacts for detailed reports"
          exit 1
        else
          echo "‚úÖ All tests passed successfully!"
        fi
    
    - name: üîó Add PR Comment (for Pull Requests)
      if: always() && github.event_name == 'pull_request'
      uses: actions/github-script@v7
      with:
        script: |
          const testStatus = process.env.TEST_FAILED === 'true' ? '‚ùå FAILED' : '‚úÖ PASSED';
          const platform = process.env.TEST_PLATFORM;
          const tags = process.env.TEST_TAGS;
          
          const comment = `
          ## üì± Mobile Test Results ${testStatus}
          
          **Platform:** \`${platform}\`  
          **Tags:** \`${tags}\`  
          **Run:** [#${{ github.run_number }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
          
          üìä [View detailed test reports in artifacts](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
          `;
          
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: comment
          });
      env:
        TEST_FAILED: ${{ env.TEST_FAILED }}
        TEST_PLATFORM: ${{ env.TEST_PLATFORM }}
        TEST_TAGS: ${{ env.TEST_TAGS }}

  # Separate job for nightly comprehensive testing
  nightly-comprehensive:
    name: Nightly Comprehensive Testing
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule'
    
    strategy:
      fail-fast: false
      matrix:
        platform: [android, androidSauce]
        test_suite: ['@createPin', '@pinValidationSuccess', '@pinValidationFailed']
    
    steps:
    - name: üì• Checkout Repository
      uses: actions/checkout@v4
    
    - name: ‚òï Set up JDK ${{ env.JAVA_VERSION }}
      uses: actions/setup-java@v4
      with:
        java-version: ${{ env.JAVA_VERSION }}
        distribution: 'temurin'
        cache: maven
    
    - name: üß™ Run Comprehensive Tests
      run: |
        echo "üåô Running nightly comprehensive test suite..."
        echo "Platform: ${{ matrix.platform }}"
        echo "Test Suite: ${{ matrix.test_suite }}"
        
        mvn clean test \
          -Dplatform=${{ matrix.platform }} \
          -Dcucumber.filter.tags="${{ matrix.test_suite }}" \
          -DfailIfNoTests=false \
          -Dmaven.test.failure.ignore=true
      env:
        SAUCELABS_USERNAME: ${{ secrets.SAUCELABS_USERNAME }}
        SAUCELABS_ACCESS_KEY: ${{ secrets.SAUCELABS_ACCESS_KEY }}
    
    - name: üì§ Upload Nightly Results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: nightly-results-${{ matrix.platform }}-${{ matrix.test_suite }}-${{ github.run_number }}
        path: |
          target/surefire-reports/
          target/allure-results/
        retention-days: 14
